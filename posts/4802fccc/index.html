<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/favicon-16x16.png?v=2.8.0" type="image/png" sizes="16x16"><link rel="icon" href="/images/favicon-32x32.png?v=2.8.0" type="image/png" sizes="32x32"><meta name="description" content="Bosscms v1.3的代审记录">
<meta property="og:type" content="article">
<meta property="og:title" content="BossCMSv1.3">
<meta property="og:url" content="https://n0sleeper.github.io/posts/4802fccc/index.html">
<meta property="og:site_name" content="n0Sleeper&#39;s Blog">
<meta property="og:description" content="Bosscms v1.3的代审记录">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20231227191759-ef7r29p.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20231227192100-kr9fj1t.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20231227195718-llmdihn.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20231227191831-f2jpcax.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20231227192434-ii16y4n.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20231227192546-2ei9ekm.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20231227192223-6aeiza1.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20231227193445-fmke89r.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20231227193921-rvx35nr.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20231228165847-iyr945t.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20231228170153-szeu17b.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20231228170252-5nqhf5g.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20231228170506-50wb09c.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103123719-eyqcyac.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103123909-t1l0a84.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103124715-3zrnp5f.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103124517-ctauark.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103125211-s8sd5a7.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103131238-1yld8em.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103131440-72rb4pc.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103131722-082e43v.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103132054-dj089f8.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103132236-i2hum7h.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103133227-9spzu8v.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103133242-rkw7mtp.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103133256-bl5ilm4.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103143614-uejfi0q.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103144145-w91t66s.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103144258-pbyfch0.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103144828-pxazrmo.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103152204-lgho1yi.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240103152215-gwewa1l.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240106152937-dxmb71e.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240106153040-fw4hn2u.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240106153343-awsjed1.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240106153429-jzbolrg.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240106153525-y2j4fj0.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240106154038-he3xba9.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240106155000-5s9ryx9.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240106155016-1wpeujq.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240106155508-vjoaueg.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240106175432-js8p3am.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240106175553-dfft1d2.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240106175626-9i0vz92.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240106175714-2q7z16a.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240106182901-hgo1p72.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240106182936-obau3vt.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240106183205-7c1le2t.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240106183229-gjpm4cp.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240107172021-nxvtvbk.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240107172217-zsfvfv6.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240107174651-y0px1y8.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240107185431-qhvolx6.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240107185449-fo4hfjq.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240107185503-2w3hhwd.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240107185509-txf6ubd.png">
<meta property="og:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20240107185513-v2tj6jv.png">
<meta property="article:published_time" content="2024-01-16T06:37:48.000Z">
<meta property="article:modified_time" content="2024-01-16T06:43:15.321Z">
<meta property="article:author" content="n0Sleeper">
<meta property="article:tag" content="代码审计">
<meta property="article:tag" content="PHP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://n0sleeper.github.io/posts/4802fccc/image-20231227191759-ef7r29p.png"><title>BossCMSv1.3 | n0Sleeper's Blog</title><link ref="canonical" href="https://n0sleeper.github.io/posts/4802fccc/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.8.0"><link rel="stylesheet" href="css/custom.css"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 7.0.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-user"></i></span><span class="header-nav-menu-item__text">关于</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">n0Sleeper's Blog</div><div class="header-banner-info__subtitle">白头并非雪可替，相识已是上上签</div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap content-wrap--noside" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">BossCMSv1.3</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2024-01-16</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2024-01-16</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">3.3k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">18分</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body">
        <h1 id="03-BossCMS-v1-3">
          <a href="#03-BossCMS-v1-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#03-BossCMS-v1-3" class="headerlink" title="03-BossCMS v1.3"></a>03-BossCMS v1.3</h1>
      <p>温州互引信息技术有限公司(以下简称互引信息、BossCMS、老板建站)是一家专注于软件开发、网站建设、模板开发、平面设计及网站安全运维的企业，主要为中小型企业及政企单位还有需要使用CMS建站系统的个人或开发团队提供新一代合规建站产品和服务。多年来我们始终围绕着互联网相关软件进行有关业务的开展和产品研究，凭借持续的研发投入及不断的创新，已发展为建站系统领域中比较完整的的CMS软件供应商。至今，BossCMS产品经过了上百多次的调整，产品操作简单、功能完善、安全可靠、可视化编辑、多语言、文件存储(支持本地或外部存储)、自定义页面URL、网站优化(SEO)设置、广告违禁词及城市分站站群等功能，BossCMS是一款基于自主研发PHP框架+MySQL架构的网站管理系统，适应各类网站的内容管理，同时备受终端用户和开发者好评的CMS建站系统。</p>

        <h1 id="理清目录结构">
          <a href="#理清目录结构" class="heading-link"><i class="fas fa-link"></i></a><a href="#理清目录结构" class="headerlink" title="理清目录结构"></a>理清目录结构</h1>
      <p>通过官方介绍，我们可以明白，BossCMS是自主研发的PHP框架。</p>
<p>看README文件，发现其采用了MVC设计模式，所以重点在于找C</p>
<p><img src="/posts/4802fccc/image-20231227191759-ef7r29p.png" alt="image"></p>
<p><img src="/posts/4802fccc/image-20231227192100-kr9fj1t.png" alt="image"></p>
<p>这说明前后台存在分离不同的功能点。所以需要区分前后台的路由访问方式。</p>
<p>‍</p>

        <h1 id="路由分析">
          <a href="#路由分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#路由分析" class="headerlink" title="路由分析"></a>路由分析</h1>
      <p>通过访问入口文件，发现其定义了四个常量，这四个常量都是前台的路由，同时直接包含了enter.php文件</p>
<p><img src="/posts/4802fccc/image-20231227195718-llmdihn.png" alt="image"></p>
<p>进入enter.php文件，发现其包含了一个into.class.php的文件，同时进行了<code>into::load()</code>操作，很明显，这里是实例化类。</p>
<p><img src="/posts/4802fccc/image-20231227191831-f2jpcax.png" alt="image"></p>
<p>跟进load()函数。调用了load_class()函数，并且传入了参数进行了<code>defined()</code>判断，回到index.php中，发现BOSSCMS_TYPE定义的是web，这说明前台index.php中定义了一些路由的常量。</p>
<p><img src="/posts/4802fccc/image-20231227192434-ii16y4n.png" alt="image"></p>
<p><img src="/posts/4802fccc/image-20231227192546-2ei9ekm.png" alt="image"></p>
<p>跟进到<code>load_class()</code>方法，并且有注释说明是加载class类文件，同时注意其第一次if判断，它判断了<code>$type</code>这个变量，给出admin还是web，这说明<code>$type</code>变量是路由中用于区分后台还是前台web。</p>
<p><img src="/posts/4802fccc/image-20231227192223-6aeiza1.png" alt="image"></p>
<p>再分析下面包含的文件部分，可以发现被包含的文件，由传入的三个变量组成，<code>$type</code>、<code>$mold</code>、<code>$part</code>从而包含了一个类文件</p>
<p>从一开始的分析，我们知道<code>$type</code>是控制前后台的，而<code>$part</code>前面有<code>/</code>且后面直接拼接<code>.class.php</code>说明，这是决定文件名的，则由此判断<code>$mold</code>是控制目录的</p>
<p><img src="/posts/4802fccc/image-20231227193445-fmke89r.png" alt="image"></p>
<p>包含完文件后，我们看一下下面的函数，判断传入的<code>$func</code>变量，既然文件都包含了，这个多半是调用文件中的方法。利用call_user_func()，通过对象的方式回调类中的方法。</p>
<p>形如：</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过对象的方式回调</span></span><br><span class="line"><span class="variable">$myobject</span> = <span class="keyword">new</span> <span class="title function_ invoke__">myclass</span>();</span><br><span class="line"><span class="title function_ invoke__">call_user_func</span>(<span class="keyword">array</span>(<span class="variable">$myobject</span>, <span class="string">&#x27;say_hello&#x27;</span>));</span><br></pre></td></tr></table></div></figure>

<p><img src="/posts/4802fccc/image-20231227193921-rvx35nr.png" alt="image"></p>
<p>‍</p>

        <h2 id="路由分析结果">
          <a href="#路由分析结果" class="heading-link"><i class="fas fa-link"></i></a><a href="#路由分析结果" class="headerlink" title="路由分析结果"></a>路由分析结果</h2>
      <p><code>$type</code>控制前后台，<code>$mold</code> 控制目录 <code>$part</code>控制类文件 <code>$func</code>控制类中调用方法</p>
<p>直接访问index.php,会自定义三种变量使其访问前台内容</p>
<p>如果访问&#x2F;admin&#x2F;index.php，也会自定义三种变量分别是：mold、part、func，只不过这三个变量可控，而<code>$type</code>变量直接由<code>IS_INSIDE</code>常量控制实现访问后台。</p>
<p>‍</p>

        <h1 id="漏洞挖掘">
          <a href="#漏洞挖掘" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞挖掘" class="headerlink" title="漏洞挖掘"></a>漏洞挖掘</h1>
      
        <h2 id="文件上传">
          <a href="#文件上传" class="heading-link"><i class="fas fa-link"></i></a><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2>
      
        <h3 id="漏洞分析">
          <a href="#漏洞分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>先找文件上传点，找到对应路由文件（这里有js前端写的验证，但是如果禁用js，整个上传点都废掉了）。就不从这里分析了。</p>
<p><img src="/posts/4802fccc/image-20231228165847-iyr945t.png" alt="image"></p>
<p>下面还有一个编辑器，里面存在图片上传（也是前端验证）和附件上传（后端验证），那么就追踪附件上传的运行逻辑</p>
<p><img src="/posts/4802fccc/image-20231228170153-szeu17b.png" alt="image"></p>
<p>追踪到controller.php文件，检测action函数，发现该文件中定义了mold，type，part，func等常量，这说明存在固定路由，访问对应文件<strong>extend&#x2F;ueditor&#x2F;php&#x2F;ueditor.class.php</strong>中的<code>init()</code>方法</p>
<p><img src="/posts/4802fccc/image-20231228170252-5nqhf5g.png" alt="image"></p>
<p>在init()方法中，找到了附件上传的函数，追踪对应代码</p>
<p><img src="/posts/4802fccc/image-20231228170506-50wb09c.png" alt="image"></p>
<p>追踪到对应函数，查看其执行逻辑，主要先找用于上传的函数，判断的地方可以先不看。</p>
<p>很明显，这里调用了一个上传的静态方法，先追踪其使用方式到<strong>system&#x2F;basic&#x2F;class&#x2F;upload.class.php</strong>文件中的<code>file()</code>函数</p>
<p><img src="/posts/4802fccc/image-20240103123719-eyqcyac.png" alt="image"></p>
<p>找到上传相关函数，这里调用的是<code>move_upload_file()</code>函数。根据该函数的使用方式，可以直接看上面的判断，进行溯源，看能否构成完整的逻辑调用链，从调用链中寻找绕过漏洞。</p>
<p><img src="/posts/4802fccc/image-20240103123909-t1l0a84.png" alt="image"></p>
<p><em>注：在后台安全设置中找到一个允许上传后缀的设置，通过抓包发现，该功能点可以控制对应config文件中的</em><code>*upload_extension*</code><em>字段</em></p>
<p><img src="/posts/4802fccc/image-20240103124715-3zrnp5f.png" alt="image"></p>
<p>继续看<strong>upload.class.php</strong>文件中的函数，通过<code>pathinfo()</code>函数获取后缀名，<code>$extension</code>变量是直接读取<strong>config</strong>文件中的，而这个允许上传后缀的<code>$extension</code>可以通过后台功能点设置，所以是可控的。</p>
<p>那么下面第一个判断<code>in_array($ext,$extension)</code>是可以控制的判断，再看第二个判断，这里需要<code>!$type</code>为true或者(<code>$type &amp;&amp; !$in</code>)为true，追踪上传时传入的函数参数传递，有传入type，所以<code>$type</code>不为null。这就要看第一个<code>if()</code>判断函数，其中涉及的<code>$type</code>变量的更改。</p>
<p><img src="/posts/4802fccc/image-20240103124517-ctauark.png" alt="image"></p>
<p><img src="/posts/4802fccc/image-20240103125211-s8sd5a7.png" alt="image"></p>
<p>这里只需要<code>$type</code>为False或者<code>$type &amp;&amp; !$in</code>为True即可。</p>
<p>分析第一个<code>if()</code>判断函数，传入的是<code>code|zip|word|excel|powerpoint|audio|text|pdf</code>，利用<code>foreach()</code>函数遍历<strong>extension.json</strong>文件中的函数，通过对比可以知道其中<code>if(in_array($k,$tarr))</code>是True，无法控制的，那么只要<code>if(in_array($ext,$v))</code>能够true就能实现<code>$type=null</code>，而通过观察extension.json文件，发现只需要传入允许的后缀即可，所以可以传入php文件。至此<strong>upload.class.php</strong>文件分析结束</p>
<p><img src="/posts/4802fccc/image-20240103131238-1yld8em.png" alt="image"></p>
<p>回到<strong>ueditor.class.php</strong>文件</p>
<p><img src="/posts/4802fccc/image-20240103131440-72rb4pc.png" alt="image"></p>
<p>这里的判断都是可控的，而且没有进行过滤，所以不用太在意。</p>
<p>所以整体调用链：调用uploadfile()函数，判断是否有参数<code>upfile</code>传入，且将其值赋值给<code>$file</code>&#x3D;&gt; 判断文件大小 &#x3D;&gt;调用文件上传函数<code>upload::file</code>,需要进入第一个<code>if()</code>判断，有文件上传且没有错误(即上传成功) &#x3D;&gt;判断后缀，这里需要借助安全设置中的配置添加php文件上传。从而绕过判断。</p>
<p><img src="/posts/4802fccc/image-20240103131722-082e43v.png" alt="image"></p>
<p>‍</p>

        <h3 id="利用方式">
          <a href="#利用方式" class="heading-link"><i class="fas fa-link"></i></a><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h3>
      <p>现在安全设置中添加允许上传的php后缀。<img src="/posts/4802fccc/image-20240103132054-dj089f8.png" alt="image"></p>
<p>寻找调用<code>uploadfile()</code>函数的功能点，根据调用的文件名ueditor.class.php可以猜测这里使用的ueditor编辑器。所以从编辑器中找文件上传，一般是附件上传<img src="/posts/4802fccc/image-20240103132236-i2hum7h.png" alt="image"></p>
<p><img src="/posts/4802fccc/image-20240103133227-9spzu8v.png" alt="image"><img src="/posts/4802fccc/image-20240103133242-rkw7mtp.png" alt="image"><img src="/posts/4802fccc/image-20240103133256-bl5ilm4.png" alt="image"></p>
<p>‍</p>
<p>‍</p>

        <h2 id="任意文件删除">
          <a href="#任意文件删除" class="heading-link"><i class="fas fa-link"></i></a><a href="#任意文件删除" class="headerlink" title="任意文件删除"></a>任意文件删除</h2>
      
        <h3 id="漏洞分析-1">
          <a href="#漏洞分析-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>同样在<strong>ueditor.class.php</strong>文件中，里面存在一个<code>delete()</code>函数</p>
<p><img src="/posts/4802fccc/image-20240103143614-uejfi0q.png" alt="image"></p>
<p>通过POST方法传入path参数，获取config文件中的<code>store_type</code>参数来判断是否进行下一步，这边动用了两个方法进行删除，一个是<code>dir::delete</code>和<code>oss::delete</code>。全局搜索**<code>store_type</code>**，发现这个是用于控制存储方式的参数，默认为0，即直接调用<code>dir::delete</code>方法</p>
<p><img src="/posts/4802fccc/image-20240103144145-w91t66s.png" alt="image"></p>
<p>在dir.class.php文件中，可以看到delete()方法中调用了unlink()函数，可以看到这里除了调用replace()方法外，就是直接判断是否为文件，从而执行<code>unlink()</code>函数</p>
<p><img src="/posts/4802fccc/image-20240103144258-pbyfch0.png" alt="image"></p>
<p>现在只需要追溯<code>replace()</code>方法的执行结果。</p>
<p>看注释是替换路径分割字符，通过分析其正则替换，只是对路径的一些字符进行替换，并没有设置什么过滤，所以可以初步判断存在任意文件删除，现在只需要根据路由构造payload，看能否成功。</p>
<p><img src="/posts/4802fccc/image-20240103144828-pxazrmo.png" alt="image"></p>
<p>‍</p>

        <h3 id="漏洞利用">
          <a href="#漏洞利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3>
      <ol>
<li>判断是否利用post方法，提交path参数</li>
<li>提交的参数是否以upload开头</li>
<li>默认采用<code>dir::delete()</code>方法，先进行replace()函数，过滤掉多余的，例如<code>//</code>,然后就直接进行unlink()函数</li>
</ol>
<p>构造Payload如下，因为这里是ueditor文件中的，所以delete功能点一定也在这个编辑器中，所以构造payload时的路由需要根据这个编辑器中的调用方式来构造。</p>
<p><img src="/posts/4802fccc/image-20240103152204-lgho1yi.png" alt="image"></p>
<p><img src="/posts/4802fccc/image-20240103152215-gwewa1l.png" alt="image"></p>
<p>‍</p>

        <h2 id="目录遍历">
          <a href="#目录遍历" class="heading-link"><i class="fas fa-link"></i></a><a href="#目录遍历" class="headerlink" title="目录遍历"></a>目录遍历</h2>
      
        <h3 id="漏洞分析-2">
          <a href="#漏洞分析-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>浏览lists()函数，发现这里对于传入的<code>$path</code>参数，并没有进行过滤，而是直接传入到<code>read()</code>函数中进行读取。通过分析，发现这里调用了两种read(),其中<code>oss::read()</code>是远程读取，<code>dir::read()</code>是本地读取，所以优先看本地读取函数</p>
<p><img src="/posts/4802fccc/image-20240106152937-dxmb71e.png" alt="image"></p>
<p><img src="/posts/4802fccc/image-20240106153040-fw4hn2u.png" alt="image"></p>
<p>看似是判断数组是否存在，实际上看<code>$val = $val[$v]</code> 有点变量覆盖的意思在其中，实现函数调用。</p>
<p>看dir::read()方法，里面调用了<code>opendir()</code>和<code>readdir()</code>函数，可以看到，对于传入的<code>$path</code>也是直接调用，并没有进行过滤等操作，最后通过return，返回读取到的文件名</p>
<p><img src="/posts/4802fccc/image-20240106153343-awsjed1.png" alt="image"></p>
<p><img src="/posts/4802fccc/image-20240106153429-jzbolrg.png" alt="image"></p>
<p>回到<code>lists()</code>方法，发现这个函数并没有直接输出，而是通过<code>return</code>返回了遍历得到的数组名，所以无法直接通过路由构造出目录遍历漏洞。需要去找调用点。–&gt;查找方法。</p>
<p><img src="/posts/4802fccc/image-20240106153525-y2j4fj0.png" alt="image"></p>
<p>找到一处调用lists()方法的地方，发现最后还是return了一组<code>json::encode</code> 的数据，同时这里也没有对传入的数据进行过滤。但是这里也没有对数据进行输出，而且这里<code>listfile()</code>方法也没有传入参数，这表明存在一个地方调用该方法。&#x3D;&gt;全文查找。</p>
<p><img src="/posts/4802fccc/image-20240106154038-he3xba9.png" alt="image"></p>
<p>最后在init()函数中找到了调用方式，通过get得到的action，利用switch跳转到对应的分支，用<code>$result</code>接收函数，最后利用<code>echo</code>输出<code>callback()</code>函数回调的结果</p>
<p><img src="/posts/4802fccc/image-20240106155000-5s9ryx9.png" alt="image"></p>
<p><img src="/posts/4802fccc/image-20240106155016-1wpeujq.png" alt="image"></p>
<p>此时只需要分析<code>config[&#39;fileManagerActionName&#39;]</code>是什么即可，追溯到config.json文件中，里面制定了action接收的是listfile时，调用listfile()方法。并且规定了默认列出的文件目录为<code>upload/</code></p>
<p><img src="/posts/4802fccc/image-20240106155508-vjoaueg.png" alt="image"></p>

        <h3 id="小结">
          <a href="#小结" class="heading-link"><i class="fas fa-link"></i></a><a href="#小结" class="headerlink" title="小结"></a>小结</h3>
      <p>整理一下整体实现逻辑链</p>
<ol>
<li>传入action参数，用于指定调用方法（这里调用的是<code>listfile()</code>）</li>
<li>调用<code>listfile()</code>方法时，直接调用<code>lists()</code>方法没有经过任何判断，默认传入<code>upload/</code>目录</li>
<li>在lists()方法中，有拼接的操作，通过审核<code>arrExist()</code>方法，发现其进行了简单的变量覆盖，通过传入<em><strong>folder</strong></em>，实现参数传递。</li>
<li>因为store_type值默认为0，所以会自动执行本地读取文件操作，即<code>dir::read()</code>,同时传入默认的<code>upload/</code>以及<em><strong>folder</strong></em>参数拼接而成的路径。</li>
<li>在<code>dir::read()</code>方法中，通过调用<code>opendir()</code>和<code>readdir()</code>两个函数，读取目录，同时返回读取到的内容。</li>
<li>最后再在init()方法中的echo输出。</li>
</ol>

        <h3 id="漏洞利用-1">
          <a href="#漏洞利用-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3>
      <p>分析过程中，我们知道了这是附件上传可能会调用到的函数。只需要控制<strong>action</strong>和添加<strong>folder</strong>这个拼接参数，就可以实现绕过。找到功能点在在线附件中。</p>
<p><img src="/posts/4802fccc/image-20240106175432-js8p3am.png" alt="image"></p>
<p>通过前面的分析，我们知道只需要传入action和folder两个参数即可，删除其他参数吗，避免造成干扰</p>
<p><img src="/posts/4802fccc/image-20240106175553-dfft1d2.png" alt="image"></p>
<p><img src="/posts/4802fccc/image-20240106175626-9i0vz92.png" alt="image"></p>
<p><img src="/posts/4802fccc/image-20240106175714-2q7z16a.png" alt="image"></p>
<p>‍</p>
<p>‍</p>

        <h2 id="任意文件下载">
          <a href="#任意文件下载" class="heading-link"><i class="fas fa-link"></i></a><a href="#任意文件下载" class="headerlink" title="任意文件下载"></a>任意文件下载</h2>
      
        <h3 id="漏洞分析-3">
          <a href="#漏洞分析-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>在后台找功能点，但凡含有下载的字样的，都可以试一试</p>
<p><img src="/posts/4802fccc/image-20240106182901-hgo1p72.png" alt="image"></p>
<p>找到对应的函数位置</p>
<p><img src="/posts/4802fccc/image-20240106182936-obau3vt.png" alt="image"></p>
<p>发现函数执行部分没有任何过滤，直接通过拼接的方式获取文件路径，然后调用readfile()函数，读取文件内容到输出缓存（这里没有接收，相当于直接下载），那么只需要直接修改接收的id值，就可以实现任意文件下载了</p>
<p>‍</p>

        <h3 id="漏洞利用-2">
          <a href="#漏洞利用-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h3>
      <p><img src="/posts/4802fccc/image-20240106183205-7c1le2t.png" alt="image"></p>
<p><img src="/posts/4802fccc/image-20240106183229-gjpm4cp.png" alt="image"></p>
<p>‍</p>

        <h2 id="权限校验逻辑缺陷">
          <a href="#权限校验逻辑缺陷" class="heading-link"><i class="fas fa-link"></i></a><a href="#权限校验逻辑缺陷" class="headerlink" title="权限校验逻辑缺陷"></a>权限校验逻辑缺陷</h2>
      
        <h3 id="漏洞分析-4">
          <a href="#漏洞分析-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析-4" class="headerlink" title="漏洞分析"></a>漏洞分析</h3>
      <p>在<strong>ueditor.class.php</strong>文件中，定义的ueditor类继承了admin，这表示需要通过admin身份验证才能够执行的操作。</p>
<p><img src="/posts/4802fccc/image-20240107172021-nxvtvbk.png" alt="image"></p>
<p>其次继承的类，通过<code>into::basic_class()</code>方法加载对应的类，追溯<code>basic_class()</code>方法。</p>
<p>因为没有传入<code>$func</code>，所以会设置<code>$func=&#39;init&#39;</code>，同时最后会进行<code>load_class()</code>方法，追溯到<code>load_class()</code>方法，这里前面分析过，就是判断是否为后端来加载类中方法。因为传入的<code>$name=&#39;admin&#39;</code>所以会加载<code>admin.class.php</code>文件中的<code>$func</code>，也就是<code>init()</code>方法</p>
<p><img src="/posts/4802fccc/image-20240107172217-zsfvfv6.png" alt="image"></p>
<p>追溯到<strong>admin.class.php</strong>文件中的<code>init()</code>方法。</p>
<p>这里可以看到通过session来判断是否登录，如果判断为空，且没有设置<code>IS_LOGIN</code>就会实现跳转。但是并没有其他函数执行，例如<code>die()</code>函数，结束执行<code>init()</code>中的代码。这就意味着如果构造后台操作路由，还是会导致执行，只不过会触发跳转到登录界面。而不是<code>die()</code>直接结束加载类</p>
<p><img src="/posts/4802fccc/image-20240107174651-y0px1y8.png" alt="image"></p>
<p>‍</p>

        <h3 id="漏洞实现">
          <a href="#漏洞实现" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞实现" class="headerlink" title="漏洞实现"></a>漏洞实现</h3>
      <p><img src="/posts/4802fccc/image-20240107185431-qhvolx6.png" alt="image"></p>
<p>‍</p>
<p><img src="/posts/4802fccc/image-20240107185449-fo4hfjq.png" alt="image"></p>
<p><img src="/posts/4802fccc/image-20240107185503-2w3hhwd.png" alt="image"></p>
<p><img src="/posts/4802fccc/image-20240107185509-txf6ubd.png" alt="image"></p>
<p><img src="/posts/4802fccc/image-20240107185513-v2tj6jv.png" alt="image"></p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="https://n0sleeper.github.io">n0Sleeper</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="https://n0sleeper.github.io/posts/4802fccc/">https://n0sleeper.github.io/posts/4802fccc/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://n0sleeper.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://n0sleeper.github.io/tags/PHP/">PHP</a></span></div><nav class="post-paginator paginator"><div class="paginator-next"><a class="paginator-next__link" href="/posts/e754e93d/"><span class="paginator-prev__text">五指cms代码审计</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2024</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>n0Sleeper</span></div><div><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__info">访问人数</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">浏览总量</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1.0.1/dist/canvas-nest.min.js" color="0,255,255" opacity="0.6" count="99" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script><script src="/js/utils.js?v=2.8.0"></script><script src="/js/stun-boot.js?v=2.8.0"></script><script src="/js/scroll.js?v=2.8.0"></script><script src="/js/header.js?v=2.8.0"></script><script src="/js/sidebar.js?v=2.8.0"></script></body></html>